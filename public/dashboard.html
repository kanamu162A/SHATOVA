<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Shatova</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
    }

    body {
      background-color: #f5f6fa;
      color: #2f3640;
    }

    .advert-bar {
      background-color: #ff4757;
      color: white;
      padding: 10px 20px;
      text-align: center;
      font-weight: bold;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 220px;
      background-color: #070795;
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      font-size: 1.8em;
      margin-bottom: 30px;
    }

    .sidebar a {
      display: block;
      margin: 12px 0;
      color: #fff;
      text-decoration: none;
      font-size: 1.1em;
      transition: 0.3s;
    }

    .sidebar a:hover {
      color: #ecf0f0;
      padding-left: 8px;
    }

    .logout {
      margin-top: auto;
      cursor: pointer;
      color: #ff6b6b;
      font-weight: bold;
    }

    .main {
      flex: 1;
      padding: 30px;
    }

    .user-card {
      background: #fff;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      margin-bottom: 30px;
      max-width: 600px;
    }

    .user-card h3 {
      margin-bottom: 10px;
    }

    .user-info p {
      margin: 8px 0;
    }

    .services {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .services button {
      padding: 12px 16px;
      background-color: #070795;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
    }

    .services button:hover {
      background-color: #2f2fe6;
    }

    .section {
      display: none;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 600px;
    }

    .section.active {
      display: block;
    }

    select, input, button {
      width: 100%;
      margin-top: 15px;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button.buy-btn {
      background-color: #070795;
      color: white;
      border: none;
    }

    .message {
      margin-top: 10px;
      text-align: center;
      font-weight: bold;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>

  <div class="advert-bar">
    ðŸŽ‰ Welcome to Shatova! Enjoy cheap data and airtime today!
  </div>

  <div class="container">
    <div class="sidebar">
      <h2>Shatova</h2>
      <a href="#">Dashboard</a>
      <a href="#">Talk to Us</a>
      <a href="#">History</a>
      <div class="logout" onclick="logout()">Log out</div>
    </div>

    <div class="main">
      <div class="user-card">
        <h3>Hello, <span id="userName">Loading...</span>!</h3>
        <div class="user-info">
          <p><strong>Email:</strong> <span id="userEmail">...</span></p>
          <p><strong>Phone:</strong> <span id="userPhone">...</span></p>
          <p><strong>Balance:</strong> â‚¦<span id="userBalance">0.00</span></p>
          <p><strong>Date Joined:</strong> <span id="created_at">Loading...</span></p>
        </div>
      </div>

      <div class="services">
        <button onclick="showSection('airtime')">Buy Airtime</button>
        <button onclick="showSection('data')">Buy Data</button>
        <button onclick="alert('More features coming soon!')">More</button>
      </div>

      <div id="data" class="section">
        <h3>Buy Data</h3>
        <select id="dataCategory" onchange="loadDataBundles()">
          <option value="">Select Data Category</option>
          <option value="mtn_sme">MTN SME</option>
          <option value="mtn_cg">MTN Corporate Gifting</option>
          <option value="mtn_weekly">MTN Weekly</option>
        </select>

        <select id="dataPlan">
          <option value="">Select Data Plan</option>
        </select>

        <input type="text" id="dataPhone" placeholder="Phone Number" />
        <button class="buy-btn" onclick="buyData()">Buy Data</button>
        <div class="message" id="dataMessage"></div>
      </div>

      <div id="airtime" class="section">
        <h3>Buy Airtime</h3>
        <p>Coming soon...</p>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("shatova_token");

    if (!token) window.location.href = "/login.html";

    function logout() {
      localStorage.removeItem("shatova_token");
      window.location.href = "/login.html";
    }

    async function fetchUser() {
      const res = await fetch("https://shatova.onrender.com/api/shatova/V1/dashboard", {
        headers: { Authorization: `Bearer ${token}` }
      });

      const data = await res.json();
      if (!data.success || !data.user) return logout();

      const user = data.user;
      document.getElementById("userName").textContent = user.first_name || "User";
      document.getElementById("userEmail").textContent = user.email;
      document.getElementById("userPhone").textContent = user.phone;
      document.getElementById("userBalance").textContent = parseFloat(user.balance || 0).toFixed(2);

      const date = new Date(user.created_at.replace(" ", "T"));
      document.getElementById("created_at").textContent = !isNaN(date)
        ? date.toLocaleDateString("en-NG", { year: "numeric", month: "long", day: "numeric" })
        : "Not available";
    }

    fetchUser();

    function showSection(id) {
      document.querySelectorAll(".section").forEach(el => el.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function loadDataBundles() {
      const category = document.getElementById("dataCategory").value;
      const planDropdown = document.getElementById("dataPlan");
      planDropdown.innerHTML = `<option value="">Select Data Plan</option>`;

      const bundles = {
        mtn_sme: [
          { name: "500MB - â‚¦100", value: "500MB" },
          { name: "1GB - â‚¦200", value: "1GB" },
          { name: "2GB - â‚¦400", value: "2GB" }
        ],
        mtn_cg: [
          { name: "1GB - â‚¦250", value: "1GB" },
          { name: "2GB - â‚¦500", value: "2GB" }
        ],
        mtn_weekly: [
          { name: "1.5GB - â‚¦500", value: "1.5GB" },
          { name: "3GB - â‚¦1000", value: "3GB" }
        ]
      };

      if (bundles[category]) {
        bundles[category].forEach(plan => {
          const option = document.createElement("option");
          option.value = plan.value;
          option.textContent = plan.name;
          planDropdown.appendChild(option);
        });
      }
    }

    async function buyData() {
      const category = document.getElementById("dataCategory").value;
      const plan = document.getElementById("dataPlan").value;
      const phone = document.getElementById("dataPhone").value.trim();
      const message = document.getElementById("dataMessage");

      if (!category || !plan || !phone) {
        message.textContent = "All fields are required.";
        message.className = "message error";
        return;
      }

      try {
        const res = await fetch("https://shatova.onrender.com/api/shatova/V1/data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ network: category, plan, phone })
        });

        const result = await res.json();

        if (result.success) {
          message.textContent = "Data purchase successful!";
          message.className = "message success";
        } else {
          throw new Error(result.message || "Failed to buy data.");
        }
      } catch (err) {
        message.textContent = err.message;
        message.className = "message error";
      }
    }
  </script>
</body>
</html>
